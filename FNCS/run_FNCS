from matplotlib import pyplot as plt
import os
import numpy as np
import tensorflow as tf


model = tf.keras.models.load_model('siamese_embedding_model.h5')

def verify(model, image_path_1, image_path_2, detection_threshold=0.5):

    img1 = preprocess(image_path_1)
    img2 = preprocess(image_path_2)
    
    img1_batch = tf.expand_dims(img1, axis=0)
    img2_batch = tf.expand_dims(img2, axis=0)
    
  # embedding the images
    embedding1 = model.predict(img1_batch)
    embedding2 = model.predict(img2_batch)
    
    # 3. calculate Distance between embeddings
    distance = np.linalg.norm(embedding1 - embedding2)
    
    print(f"Distance: {distance:.4f}")
    
    if distance < detection_threshold:
        print("Result: Not the same person")
        return True, distance
    else:
        print("Result: The same person")
        return False, distance



test_anchor_path = os.path.join('Images', 'anchor.jpg')
test_pos_path = os.path.join('Images', 'camera_output.jpg')

print("--- Testing Match ---")
verify(trained_embedding, test_anchor_path, test_pos_path, detection_threshold=0.6)


fig, axs = plt.subplots(1, 3, figsize=(10, 5))

axs[0].imshow(preprocess(test_anchor_path))
axs[0].set_title("Anchor")
axs[0].axis("off")

axs[1].imshow(preprocess(test_pos_path))
axs[1].set_title("Detected person")
axs[1].axis("off")
