from matplotlib import pyplot as plt
import os
import numpy as np
import tensorflow as tf

interpreter = tf.lite.Interpreter(model_path="siamese_embedding_model.tflite")
interpreter.allocate_tensors()

#input_details = interpreter.get_input_details()
#output_details = interpreter.get_output_details()

def get_embedding(interpreter, input_img):
    # 1. Point to the input index
    input_index = interpreter.get_input_details()[0]['index']
    
    # 2. Add batch dimension (1, 100, 100, 3) - adjust based on your model input
    input_tensor = np.expand_dims(input_img, axis=0).astype(np.float32)
    
    # 3. Set the tensor
    interpreter.set_tensor(input_index, input_tensor)
    
    # 4. Run inference
    interpreter.invoke()
    
    # 5. Get the result
    output_index = output_details[0]['index']
    embedding = interpreter.get_tensor(output_index)
    
    return embedding

def verify(model, image_path_1, image_path_2, detection_threshold=0.5):

    img1 = preprocess(image_path_1)
    img2 = preprocess(image_path_2)
    
    img1_batch = tf.expand_dims(img1, axis=0)
    img2_batch = tf.expand_dims(img2, axis=0)
    
  # embedding the images
    embedding1 = get_embedding(interpreter, img1_batch)
    embedding2 = get_embedding(interpreter, img2_batch)
    
    # 3. calculate Distance between embeddings
    distance = np.linalg.norm(embedding1 - embedding2)
    
    print(f"Distance: {distance:.4f}")
    
    if distance < detection_threshold:
        print("Result: Not the same person")
        return True, distance
    else:
        print("Result: The same person")
        return False, distance



test_anchor_path = os.path.join('Images', 'anchor.jpg')
test_pos_path = os.path.join('Images', 'camera_output.jpg')

print("--- Testing Match ---")
verify(interpreter, test_anchor_path, test_pos_path, detection_threshold=0.6)


fig, axs = plt.subplots(1, 3, figsize=(10, 5))

axs[0].imshow(preprocess(test_anchor_path))
axs[0].set_title("Anchor")
axs[0].axis("off")

axs[1].imshow(preprocess(test_pos_path))
axs[1].set_title("Detected person")
axs[1].axis("off")